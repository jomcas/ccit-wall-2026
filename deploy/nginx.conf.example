# NGINX Security Configuration Example
#
# This file demonstrates how to configure NGINX as a reverse proxy and WAF
# in front of the CCIT Wall backend application.
#
# Features covered:
# - Hide server version
# - Disable directory listing
# - Block dangerous HTTP methods (TRACE, CONNECT)
# - Rate limiting
# - Admin route IP allowlisting
# - HTTPS/TLS setup
# - Security headers (as backup/supplement to Helmet)
#
# Setup:
# 1. Customize the upstream and server_name values
# 2. Obtain SSL certificates (e.g., via Let's Encrypt with certbot)
# 3. Copy to /etc/nginx/sites-available/ccit-wall
# 4. Create symlink: ln -s /etc/nginx/sites-available/ccit-wall /etc/nginx/sites-enabled/
# 5. Test: nginx -t
# 6. Reload: systemctl reload nginx

# ==============================================================================
# Rate Limiting Zone (optional but recommended)
# ==============================================================================
# Define a rate limit zone for global and per-endpoint limiting.
# This is used in the server{} block below.
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=admin:10m rate=3r/m;

# ==============================================================================
# Upstream Backend
# ==============================================================================
# Define your backend application server(s).
# You can add multiple backend servers here for load balancing.
upstream ccit_wall_backend {
  server localhost:4000 max_fails=3 fail_timeout=30s;
  # server localhost:4001 max_fails=3 fail_timeout=30s;  # For load balancing
  keepalive 32;
}

# ==============================================================================
# HTTP to HTTPS Redirect
# ==============================================================================
# Always redirect unencrypted traffic to HTTPS for security.
server {
  listen 80;
  listen [::]:80;
  server_name your-domain.com www.your-domain.com;
  
  # Allow Let's Encrypt ACME challenge
  location /.well-known/acme-challenge/ {
    root /var/www/certbot;
  }
  
  # Redirect all other traffic to HTTPS
  location / {
    return 301 https://$server_name$request_uri;
  }
}

# ==============================================================================
# Main HTTPS Server Block
# ==============================================================================
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name your-domain.com www.your-domain.com;
  
  # ===========================================================================
  # SSL/TLS Configuration
  # ===========================================================================
  # Update these paths to your certificate locations
  ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
  
  # Use modern, secure TLS versions only
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;
  
  # HSTS: Force HTTPS for all future requests
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  
  # ===========================================================================
  # Security Headers (Complement to Helmet in backend)
  # ===========================================================================
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header Referrer-Policy "no-referrer" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), magnetometer=(), gyroscope=()" always;
  
  # ===========================================================================
  # Fingerprinting Mitigation
  # ===========================================================================
  # Hide NGINX version in error pages and response headers
  server_tokens off;
  
  # ===========================================================================
  # Directory Listing Prevention
  # ===========================================================================
  # Disable automatic directory listing
  autoindex off;
  
  # ===========================================================================
  # HTTP Method Restrictions (WAF)
  # ===========================================================================
  # Block dangerous HTTP methods
  if ($request_method = TRACE) {
    return 405;
  }
  if ($request_method = CONNECT) {
    return 405;
  }
  
  # ===========================================================================
  # Global Rate Limiting
  # ===========================================================================
  limit_req zone=general burst=20 nodelay;
  
  # ===========================================================================
  # Logging
  # ===========================================================================
  access_log /var/log/nginx/ccit-wall-access.log;
  error_log /var/log/nginx/ccit-wall-error.log warn;
  
  # ===========================================================================
  # Proxy Configuration to Backend
  # ===========================================================================
  location / {
    # Route requests to the backend upstream
    proxy_pass http://ccit_wall_backend;
    
    # =======================
    # Proxy Headers
    # =======================
    # Forward the real client IP to the backend (important for logging, rate limiting, and IP allowlist)
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Preserve Host header for CORS and virtual hosting
    proxy_set_header Host $host;
    
    # =======================
    # Connection Settings
    # =======================
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_read_timeout 60s;
    proxy_connect_timeout 60s;
    
    # =======================
    # Buffering (can be tuned for performance)
    # =======================
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
  }
  
  # ===========================================================================
  # Authentication/Admin Routes with IP Allowlist
  # ===========================================================================
  location /api/admin {
    # Restrict admin access to specific IP ranges (CIDR notation)
    # This is a whitelist: if the client IP is NOT in one of these ranges, deny.
    
    # Example: Allow access from internal office network and home office
    allow 10.0.0.0/8;           # Internal office network
    allow 192.168.1.0/24;        # Example home office
    allow 203.0.113.50;          # Specific admin IP
    
    # Deny all other IPs
    deny all;
    
    # Route to backend
    proxy_pass http://ccit_wall_backend;
    
    # Apply stricter rate limiting for admin endpoints
    limit_req zone=admin burst=5 nodelay;
    
    # Forward headers (same as above)
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_read_timeout 60s;
    proxy_connect_timeout 60s;
  }
  
  # ===========================================================================
  # Authentication Routes with Moderate Rate Limiting
  # ===========================================================================
  location /api/auth {
    # Apply stricter rate limiting for auth endpoints to prevent brute force
    limit_req zone=auth burst=10 nodelay;
    
    proxy_pass http://ccit_wall_backend;
    
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header Host $host;
    
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_read_timeout 60s;
    proxy_connect_timeout 60s;
  }
  
  # ===========================================================================
  # Health Check (for load balancers, no rate limiting)
  # ===========================================================================
  location /health {
    proxy_pass http://ccit_wall_backend;
    proxy_set_header Host $host;
    access_log off;  # Don't log health checks
  }
  
  # ===========================================================================
  # Deny Access to Hidden/Sensitive Files
  # ===========================================================================
  location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
  }
  
  location ~ ~$ {
    deny all;
    access_log off;
    log_not_found off;
  }
}
